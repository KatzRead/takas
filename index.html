import React, { useEffect, useMemo, useRef, useState, createContext, useContext } from "react";

/**
 * CS2 Trade Site Starter (Single-file React)
 * - Dark theme, responsive, TR/EN language toggle
 * - Pages: Marketplace, My Inventory, Compare, Admin, Contact
 * - Admin panel: add/edit/remove items; import/export JSON
 * - LocalStorage DB (no server). You can later hook to a real backend.
 * - Hash router (works on GitHub Pages without special config)
 *
 * Next steps to deploy:
 * 1) Create a new repo, add this file as App.jsx inside a Vite React project OR keep as-is in this Canvas.
 * 2) Build for static hosting (Vite) and publish to GitHub Pages.
 * 3) Until you wire a backend, all data lives in the browser (your machine).
 */

/************************************
 * Tiny Hash Router
 ************************************/
const useHashRoute = () => {
  const [route, setRoute] = useState(() => window.location.hash.replace(/^#\/?/, "") || "market");
  useEffect(() => {
    const onHash = () => setRoute(window.location.hash.replace(/^#\/?/, "") || "market");
    window.addEventListener("hashchange", onHash);
    return () => window.removeEventListener("hashchange", onHash);
  }, []);
  const navigate = (to) => (window.location.hash = to);
  return [route, navigate];
};

/************************************
 * LocalStorage DB
 ************************************/
const DB_KEY = "cs2-trade-starter-db-v1";
const defaultSkins = [
  {
    id: "ak-neon-rev-001",
    name: "AK-47 | Neon Revolution",
    marketName: "AK-47 | Neon Revolution (Factory New)",
    weapon: "AK-47",
    exterior: "Factory New",
    float: 0.03,
    price: 420.0,
    currency: "USD",
    image: "https://steamcommunity-a.akamaihd.net/economy/image/class/730/188530708/300x200",
    rarity: "Covert",
    collection: "Gamma 2 Case",
    statTrak: false,
  },
  {
    id: "m4a1-print-002",
    name: "M4A1-S | Printstream",
    marketName: "M4A1-S | Printstream (Minimal Wear)",
    weapon: "M4A1-S",
    exterior: "Minimal Wear",
    float: 0.10,
    price: 600.0,
    currency: "USD",
    image: "https://steamcommunity-a.akamaihd.net/economy/image/class/730/191426551/300x200",
    rarity: "Covert",
    collection: "Operation Broken Fang Case",
    statTrak: true,
  },
  {
    id: "awp-dragon-003",
    name: "AWP | Dragon Lore",
    marketName: "AWP | Dragon Lore (Field-Tested)",
    weapon: "AWP",
    exterior: "Field-Tested",
    float: 0.24,
    price: 8000.0,
    currency: "USD",
    image: "https://steamcommunity-a.akamaihd.net/economy/image/class/730/188530139/300x200",
    rarity: "Covert",
    collection: "Cobblestone Collection",
    statTrak: false,
  },
];

const loadDB = () => {
  try {
    const raw = localStorage.getItem(DB_KEY);
    if (!raw) {
      const seed = { skins: defaultSkins, inventory: [], compare: [], language: "tr" };
      localStorage.setItem(DB_KEY, JSON.stringify(seed));
      return seed;
    }
    return JSON.parse(raw);
  } catch (e) {
    console.error("DB parse error", e);
    return { skins: defaultSkins, inventory: [], compare: [], language: "tr" };
  }
};

const saveDB = (db) => {
  localStorage.setItem(DB_KEY, JSON.stringify(db));
};

/************************************
 * i18n (simple, inline)
 ************************************/
const strings = {
  tr: {
    marketplace: "Pazar",
    myInventory: "Envanterim",
    compare: "Karşılaştır",
    admin: "Yönetim",
    contact: "İletişim",
    search: "Ara...",
    addToInventory: "Envantere Ekle",
    listedForSale: "Satılık",
    price: "Fiyat",
    currency: "Para Birimi",
    weapon: "Silah",
    exterior: "Dış Görünüm",
    float: "Float",
    rarity: "Nadirlik",
    collection: "Koleksiyon",
    statTrak: "StatTrak",
    actions: "İşlemler",
    edit: "Düzenle",
    remove: "Sil",
    addItem: "Ürün Ekle",
    save: "Kaydet",
    cancel: "İptal",
    import: "İçe Aktar",
    export: "Dışa Aktar",
    uploadJSON: "JSON yükle",
    listedOnly: "Sadece satılık",
    language: "Dil",
    darkTheme: "Koyu Tema",
    yourSaleInventory: "Satılık Envanterin",
    markForSale: "Satılık İşaretle",
    setPrice: "Fiyat Belirle",
    compareSelected: "Seçilenleri Karşılaştır",
    reset: "Sıfırla",
    empty: "Boş",
    contactText: "Sponsor, işbirliği ve destek için iletişim linklerin:",
    socials: "Sosyal Linkler",
  },
  en: {
    marketplace: "Marketplace",
    myInventory: "My Inventory",
    compare: "Compare",
    admin: "Admin",
    contact: "Contact",
    search: "Search...",
    addToInventory: "Add to Inventory",
    listedForSale: "Listed",
    price: "Price",
    currency: "Currency",
    weapon: "Weapon",
    exterior: "Exterior",
    float: "Float",
    rarity: "Rarity",
    collection: "Collection",
    statTrak: "StatTrak",
    actions: "Actions",
    edit: "Edit",
    remove: "Remove",
    addItem: "Add Item",
    save: "Save",
    cancel: "Cancel",
    import: "Import",
    export: "Export",
    uploadJSON: "Upload JSON",
    listedOnly: "Listed only",
    language: "Language",
    darkTheme: "Dark Theme",
    yourSaleInventory: "Your Sale Inventory",
    markForSale: "Mark for Sale",
    setPrice: "Set Price",
    compareSelected: "Compare Selected",
    reset: "Reset",
    empty: "Empty",
    contactText: "For sponsorships, collabs and support, use your links:",
    socials: "Social Links",
  },
};

const LangCtx = createContext({ lang: "tr", t: (k) => k, setLang: () => {} });
const useT = () => useContext(LangCtx);

/************************************
 * Global Store (no external libs)
 ************************************/
const StoreCtx = createContext(null);
const useStore = () => useContext(StoreCtx);

function StoreProvider({ children }) {
  const [db, setDb] = useState(loadDB);
  const update = (patch) => setDb((prev) => {
    const next = typeof patch === "function" ? patch(prev) : { ...prev, ...patch };
    saveDB(next);
    return next;
  });
  const value = useMemo(() => ({ db, update }), [db]);
  return <StoreCtx.Provider value={value}>{children}</StoreCtx.Provider>;
}

/************************************
 * UI Primitives
 ************************************/
const Card = ({ children, className = "" }) => (
  <div className={`rounded-2xl shadow-lg bg-neutral-900 border border-neutral-800 ${className}`}>{children}</div>
);
const Button = ({ children, onClick, className = "", type = "button" }) => (
  <button type={type} onClick={onClick} className={`px-4 py-2 rounded-xl bg-neutral-800 hover:bg-neutral-700 border border-neutral-700 ${className}`}>
    {children}
  </button>
);
const Input = (props) => (
  <input {...props} className={`w-full px-3 py-2 rounded-xl bg-neutral-900 border border-neutral-700 focus:outline-none ${props.className || ""}`} />
);
const Switch = ({ checked, onChange }) => (
  <label className="inline-flex items-center cursor-pointer select-none">
    <span className="mr-2 text-sm text-neutral-400">Off</span>
    <div className="relative">
      <input type="checkbox" className="sr-only" checked={checked} onChange={(e) => onChange(e.target.checked)} />
      <div className={`block w-12 h-7 rounded-full ${checked ? "bg-emerald-600" : "bg-neutral-700"}`}></div>
      <div className={`dot absolute left-1 top-1 bg-white w-5 h-5 rounded-full transition ${checked ? "translate-x-5" : ""}`}></div>
    </div>
  </label>
);

/************************************
 * Navbar
 ************************************/
function Navbar({ navigate }) {
  const { db } = useStore();
  const { lang, setLang } = useT();
  const t = strings[lang];
  const link = (to, label) => (
    <a href={`#${to}`} className="px-3 py-2 rounded-xl hover:bg-neutral-800 border border-transparent hover:border-neutral-700">
      {label}
    </a>
  );
  return (
    <div className="sticky top-0 z-40 backdrop-blur bg-black/60 border-b border-neutral-800">
      <div className="max-w-7xl mx-auto px-4 py-3 flex items-center gap-2">
        <div className="text-xl font-bold">takas.yt</div>
        <div className="ml-4 flex items-center gap-1 text-sm">
          {link("market", t.marketplace)}
          {link("inventory", t.myInventory)}
          {link("compare", t.compare)}
          {link("admin", t.admin)}
          {link("contact", t.contact)}
        </div>
        <div className="ml-auto flex items-center gap-3">
          <select value={lang} onChange={(e) => setLang(e.target.value)} className="bg-neutral-900 border border-neutral-700 rounded-xl px-3 py-2 text-sm">
            <option value="tr">TR</option>
            <option value="en">EN</option>
          </select>
        </div>
      </div>
    </div>
  );
}

/************************************
 * Marketplace
 ************************************/
function Marketplace() {
  const { db, update } = useStore();
  const { lang } = useT();
  const t = strings[lang];
  const [q, setQ] = useState("");
  const [rarity, setRarity] = useState("all");

  const filtered = db.skins.filter((s) => {
    const text = `${s.name} ${s.weapon} ${s.exterior} ${s.collection}`.toLowerCase();
    const okQ = text.includes(q.toLowerCase());
    const okR = rarity === "all" || s.rarity === rarity;
    return okQ && okR;
  });

  const addToInv = (skin) => {
    update((prev) => ({
      ...prev,
      inventory: [
        ...prev.inventory,
        { id: skin.id, price: skin.price, listed: false, currency: skin.currency },
      ],
    }));
  };

  const toggleCompare = (id) => {
    update((prev) => {
      const inList = prev.compare.includes(id);
      const next = inList ? prev.compare.filter((x) => x !== id) : [...prev.compare, id].slice(-4);
      return { ...prev, compare: next };
    });
  };

  return (
    <div className="max-w-7xl mx-auto px-4 py-8">
      <div className="flex flex-col md:flex-row gap-3 mb-4">
        <Input placeholder={t.search} value={q} onChange={(e) => setQ(e.target.value)} />
        <select value={rarity} onChange={(e) => setRarity(e.target.value)} className="bg-neutral-900 border border-neutral-700 rounded-xl px-3 py-2">
          <option value="all">All Rarities</option>
          <option>Consumer</option>
          <option>Industrial</option>
          <option>Mil-Spec</option>
          <option>Restricted</option>
          <option>Classified</option>
          <option>Covert</option>
          <option>Exceedingly Rare</option>
        </select>
        <a href="#compare" className="ml-auto">
          <Button>{t.compare} ({db.compare.length})</Button>
        </a>
      </div>
      <div className="grid sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
        {filtered.map((s) => (
          <Card key={s.id} className="overflow-hidden">
            <div className="aspect-[3/2] bg-neutral-950 flex items-center justify-center">
              <img src={s.image} alt={s.marketName} className="max-h-full" />
            </div>
            <div className="p-4">
              <div className="flex items-center justify-between">
                <div className="font-semibold">{s.name}</div>
                <span className="text-xs px-2 py-1 rounded-full border border-neutral-700">{s.rarity}</span>
              </div>
              <div className="text-sm text-neutral-400 mt-1">{s.exterior} • Float {s.float}</div>
              <div className="mt-2 font-bold">{s.price} {s.currency}</div>
              <div className="mt-3 flex gap-2">
                <Button onClick={() => addToInv(s)} className="flex-1">{t.addToInventory}</Button>
                <Button onClick={() => toggleCompare(s.id)} className={`${db.compare.includes(s.id) ? "ring-2 ring-emerald-500" : ""}`}>★</Button>
              </div>
            </div>
          </Card>
        ))}
        {filtered.length === 0 && (
          <div className="text-neutral-400">{t.empty}</div>
        )}
      </div>
    </div>
  );
}

/************************************
 * Inventory (with For Sale toggle & pricing)
 ************************************/
function Inventory() {
  const { db, update } = useStore();
  const { lang } = useT();
  const t = strings[lang];
  const [listedOnly, setListedOnly] = useState(false);

  const items = db.inventory
    .map((inv) => ({ inv, skin: db.skins.find((s) => s.id === inv.id) }))
    .filter(({ inv }) => (listedOnly ? inv.listed : true));

  const setInv = (id, patch) => {
    update((prev) => ({
      ...prev,
      inventory: prev.inventory.map((x) => (x.id === id ? { ...x, ...patch } : x)),
    }));
  };

  const removeInv = (id) => {
    update((prev) => ({ ...prev, inventory: prev.inventory.filter((x) => x.id !== id) }));
  };

  return (
    <div className="max-w-7xl mx-auto px-4 py-8">
      <div className="flex items-center gap-3 mb-4">
        <span className="text-sm text-neutral-400">{t.listedOnly}</span>
        <Switch checked={listedOnly} onChange={setListedOnly} />
      </div>
      <div className="grid sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
        {items.map(({ inv, skin }) => (
          <Card key={inv.id} className="overflow-hidden">
            <div className="aspect-[3/2] bg-neutral-950 flex items-center justify-center">
              <img src={skin?.image} alt={skin?.marketName} className="max-h-full" />
            </div>
            <div className="p-4 space-y-2">
              <div className="font-semibold">{skin?.name || inv.id}</div>
              <div className="text-sm text-neutral-400">{skin?.exterior} • Float {skin?.float}</div>
              <div className="flex items-center gap-2">
                <Input type="number" step="0.01" value={inv.price} onChange={(e) => setInv(inv.id, { price: parseFloat(e.target.value || 0) })} />
                <Input value={inv.currency} onChange={(e) => setInv(inv.id, { currency: e.target.value })} className="w-28" />
              </div>
              <div className="flex items-center gap-3">
                <label className="inline-flex gap-2 items-center text-sm">
                  <input type="checkbox" checked={inv.listed} onChange={(e) => setInv(inv.id, { listed: e.target.checked })} />
                  {t.markForSale}
                </label>
                <Button onClick={() => removeInv(inv.id)} className="ml-auto">Remove</Button>
              </div>
            </div>
          </Card>
        ))}
        {items.length === 0 && (
          <div className="text-neutral-400">{t.empty}</div>
        )}
      </div>
    </div>
  );
}

/************************************
 * Compare Page (up to 4)
 ************************************/
function Compare() {
  const { db, update } = useStore();
  const { lang } = useT();
  const t = strings[lang];
  const selected = db.compare.map((id) => db.skins.find((s) => s.id === id)).filter(Boolean);

  const reset = () => update((prev) => ({ ...prev, compare: [] }));

  return (
    <div className="max-w-7xl mx-auto px-4 py-8">
      <div className="flex items-center gap-3 mb-4">
        <a href="#market"><Button>{t.compareSelected}</Button></a>
        <Button onClick={reset} className="ml-auto">{t.reset}</Button>
      </div>
      <div className="grid md:grid-cols-2 lg:grid-cols-4 gap-4">
        {selected.map((s) => (
          <Card key={s.id} className="overflow-hidden">
            <div className="aspect-[3/2] bg-neutral-950 flex items-center justify-center">
              <img src={s.image} alt={s.marketName} className="max-h-full" />
            </div>
            <div className="p-4 space-y-1 text-sm">
              <div className="font-semibold">{s.name}</div>
              <div>{t.weapon}: {s.weapon}</div>
              <div>{t.exterior}: {s.exterior}</div>
              <div>{t.float}: {s.float}</div>
              <div>{t.rarity}: {s.rarity}</div>
              <div>{t.collection}: {s.collection}</div>
              <div className="font-bold mt-2">{t.price}: {s.price} {s.currency}</div>
            </div>
          </Card>
        ))}
        {selected.length === 0 && <div className="text-neutral-400">{t.empty}</div>}
      </div>
    </div>
  );
}

/************************************
 * Admin Panel
 ************************************/
function Admin() {
  const { db, update } = useStore();
  const { lang } = useT();
  const t = strings[lang];
  const [editing, setEditing] = useState(null);
  const fileRef = useRef();

  const blank = {
    id: "",
    name: "",
    marketName: "",
    weapon: "",
    exterior: "Factory New",
    float: 0,
    price: 0,
    currency: "USD",
    image: "",
    rarity: "Mil-Spec",
    collection: "",
    statTrak: false,
  };

  const [form, setForm] = useState(blank);

  const onEdit = (skin) => {
    setEditing(skin.id);
    setForm(skin);
  };

  const onRemove = (id) => {
    update((prev) => ({
      ...prev,
      skins: prev.skins.filter((s) => s.id !== id),
      inventory: prev.inventory.filter((x) => x.id !== id),
      compare: prev.compare.filter((x) => x !== id),
    }));
  };

  const onSubmit = (e) => {
    e.preventDefault();
    update((prev) => {
      const exists = prev.skins.find((s) => s.id === form.id);
      const skins = exists
        ? prev.skins.map((s) => (s.id === form.id ? form : s))
        : [...prev.skins, form];
      return { ...prev, skins };
    });
    setEditing(null);
    setForm(blank);
  };

  const onExport = () => {
    const blob = new Blob([JSON.stringify(db, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "cs2-trade-db.json";
    a.click();
    URL.revokeObjectURL(url);
  };

  const onImport = async (file) => {
    if (!file) return;
    const txt = await file.text();
    try {
      const json = JSON.parse(txt);
      if (!json || typeof json !== "object") throw new Error("Invalid JSON");
      update(json);
    } catch (e) {
      alert("Invalid JSON file");
    }
  };

  return (
    <div className="max-w-7xl mx-auto px-4 py-8">
      <div className="flex items-center gap-3 mb-6">
        <Button onClick={onExport}>{t.export}</Button>
        <input type="file" accept="application/json" ref={fileRef} className="hidden" onChange={(e) => onImport(e.target.files?.[0])} />
        <Button onClick={() => fileRef.current?.click()}>{t.import}</Button>
      </div>

      <Card className="p-4 mb-8">
        <div className="font-semibold mb-3">{editing ? `${t.edit}: ${editing}` : t.addItem}</div>
        <form onSubmit={onSubmit} className="grid md:grid-cols-3 gap-3">
          <Input placeholder="id" value={form.id} onChange={(e) => setForm({ ...form, id: e.target.value })} required />
          <Input placeholder="name" value={form.name} onChange={(e) => setForm({ ...form, name: e.target.value })} required />
          <Input placeholder="marketName" value={form.marketName} onChange={(e) => setForm({ ...form, marketName: e.target.value })} />
          <Input placeholder="weapon" value={form.weapon} onChange={(e) => setForm({ ...form, weapon: e.target.value })} />
          <Input placeholder="exterior" value={form.exterior} onChange={(e) => setForm({ ...form, exterior: e.target.value })} />
          <Input type="number" step="0.0001" placeholder="float" value={form.float} onChange={(e) => setForm({ ...form, float: parseFloat(e.target.value || 0) })} />
          <Input type="number" step="0.01" placeholder="price" value={form.price} onChange={(e) => setForm({ ...form, price: parseFloat(e.target.value || 0) })} />
          <Input placeholder="currency" value={form.currency} onChange={(e) => setForm({ ...form, currency: e.target.value })} />
          <Input placeholder="image URL" value={form.image} onChange={(e) => setForm({ ...form, image: e.target.value })} />
          <Input placeholder="rarity" value={form.rarity} onChange={(e) => setForm({ ...form, rarity: e.target.value })} />
          <Input placeholder="collection" value={form.collection} onChange={(e) => setForm({ ...form, collection: e.target.value })} />
          <label className="flex items-center gap-2">
            <input type="checkbox" checked={form.statTrak} onChange={(e) => setForm({ ...form, statTrak: e.target.checked })} /> StatTrak
          </label>
          <div className="md:col-span-3 flex gap-3">
            <Button type="submit">{editing ? strings[lang].save : strings[lang].addItem}</Button>
            {editing && (
              <Button type="button" onClick={() => { setEditing(null); setForm(blank); }}>{strings[lang].cancel}</Button>
            )}
          </div>
        </form>
      </Card>

      <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
        {db.skins.map((s) => (
          <Card key={s.id} className="overflow-hidden">
            <div className="aspect-[3/2] bg-neutral-950 flex items-center justify-center">
              <img src={s.image} alt={s.marketName} className="max-h-full" />
            </div>
            <div className="p-4 space-y-1">
              <div className="font-semibold">{s.name}</div>
              <div className="text-sm text-neutral-400">{s.exterior} • Float {s.float}</div>
              <div className="font-bold">{s.price} {s.currency}</div>
              <div className="flex gap-2 mt-2">
                <Button onClick={() => onEdit(s)}>{strings[lang].edit}</Button>
                <Button onClick={() => onRemove(s.id)}>{strings[lang].remove}</Button>
              </div>
            </div>
          </Card>
        ))}
      </div>
    </div>
  );
}

/************************************
 * Contact Page
 ************************************/
function Contact() {
  const { lang } = useT();
  const t = strings[lang];
  return (
    <div className="max-w-3xl mx-auto px-4 py-10">
      <Card className="p-6">
        <div className="text-xl font-semibold mb-2">{t.contact}</div>
        <p className="text-neutral-300 mb-4">{t.contactText}</p>
        <ul className="space-y-2">
          <li><a className="underline" href="https://twitch.tv/yourname" target="_blank" rel="noreferrer">Twitch</a></li>
          <li><a className="underline" href="https://kick.com/yourname" target="_blank" rel="noreferrer">Kick</a></li>
          <li><a className="underline" href="https://x.com/yourname" target="_blank" rel="noreferrer">Twitter/X</a></li>
          <li><a className="underline" href="mailto:you@example.com">you@example.com</a></li>
        </ul>
      </Card>
    </div>
  );
}

/************************************
 * Root App
 ************************************/
export default function App() {
  const [route] = useHashRoute();
  const [lang, setLang] = useState(() => loadDB().language || "tr");
  const { db, update } = useStoreShim();

  useEffect(() => {
    update((prev) => ({ ...prev, language: lang }));
  }, [lang]);

  return (
    <LangCtx.Provider value={{ lang, setLang }}>
      <StoreProvider>
        <div className="min-h-screen bg-black text-neutral-100">
          <Navbar />
          {route === "market" && <Marketplace />}
          {route === "inventory" && <Inventory />}
          {route === "compare" && <Compare />}
          {route === "admin" && <Admin />}
          {route === "contact" && <Contact />}
          <footer className="border-t border-neutral-800 text-center text-xs text-neutral-500 py-6">© {new Date().getFullYear()} takas.yt — CS2 Item Trading Starter</footer>
        </div>
      </StoreProvider>
    </LangCtx.Provider>
  );
}

/************************************
 * Store shim to ensure language load
 ************************************/
function useStoreShim() {
  // A very small shim to let App set the initial language before StoreProvider mount
  const [db, setDb] = useState(loadDB());
  const update = (patch) => setDb((prev) => {
    const next = typeof patch === "function" ? patch(prev) : { ...prev, ...patch };
    saveDB(next);
    return next;
  });
  return { db, update };
}
